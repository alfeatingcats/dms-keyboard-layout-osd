name: Release Plugin

on:
  push:
    tags:
      - 'v*.*.*' 

jobs:
  validate:
    name: Validate Plugin
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate plugin.json
        run: |
          if ! jq empty plugin.json 2>/dev/null; then
            echo "âŒ plugin.json is not valid JSON"
            exit 1
          fi
          echo "âœ… plugin.json is valid"

      - name: Check required files
        run: |
          required_files=("plugin.json" "KeyboardLayoutWatcher.qml" "KeyboardLayoutOSD.qml" "README.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
          echo "âœ… All required files present"

      - name: Extract and validate version
        run: |
          VERSION=$(jq -r '.version' plugin.json)
          
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/v}
            
            if [ "$VERSION" != "$TAG" ]; then
              echo "âŒ Version mismatch!"
              echo "plugin.json version: $VERSION"
              echo "Git tag version: $TAG"
              exit 1
            fi
            echo "âœ… Version matches: $VERSION"
          else
            echo "âš ï¸ Manual workflow run - skipping version validation"
            echo "Using version from plugin.json: $VERSION"
          fi

  release:
    name: Create Release
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            VERSION=$(jq -r '.version' plugin.json)
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Create plugin archive
        run: |
          mkdir -p release
          cp plugin.json KeyboardLayoutWatcher.qml KeyboardLayoutOSD.qml README.md release/
          cd release
          zip -r ../keyboard-layout-osd-v${{ steps.get_version.outputs.VERSION }}.zip .
          cd ..

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          PLUGIN_NAME=$(jq -r '.name' plugin.json)
          DESCRIPTION=$(jq -r '.description' plugin.json)
          
          cat > release_notes.md << EOF
          ## ðŸŽ‰ $PLUGIN_NAME v$VERSION
          
          $DESCRIPTION
          
          ### ðŸ“¦ Installation
          
          \`\`\`bash
          cd ~/.config/DankMaterialShell/plugins
          wget https://github.com/${{ github.repository }}/releases/download/v$VERSION/keyboard-layout-osd-v$VERSION.zip
          unzip keyboard-layout-osd-v$VERSION.zip -d KeyboardLayoutOSD
          \`\`\`
          
          Or install manually from source.
          
          ### ðŸ“‹ Requirements
          - DankMaterialShell (latest)
          - Niri compositor
          
          ### ðŸ”— Links
          - [Installation Guide](README.md)
          - [Report Issues](https://github.com/${{ github.repository }}/issues)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.get_version.outputs.VERSION }}
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            keyboard-layout-osd-v${{ steps.get_version.outputs.VERSION }}.zip
            plugin.json
            KeyboardLayoutWatcher.qml
            KeyboardLayoutOSD.qml
            README.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success message
        run: |
          echo "âœ… Release v${{ steps.get_version.outputs.VERSION }} created successfully!"
          echo "ðŸ“¦ Download: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }}"